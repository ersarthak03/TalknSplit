<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TalknSplit</title>
  <style>
    /* =====================================================
       TalknSplit - Dashboard Layout + Existing Styling
       ===================================================== */
    :root {
      --bg-primary: #0a0e1a;
      --bg-secondary: #0f1724;
      --bg-card: #1a1f2e;
      --text-primary: #e6eef6;
      --text-secondary: #9aa4b2;
      --text-muted: #6b7280;
      --accent-primary: #6ee7b7;
      --accent-secondary: #60a5fa;
      --border-subtle: rgba(255, 255, 255, 0.06);
      --border-muted: rgba(255, 255, 255, 0.03);
      --glass-light: rgba(255, 255, 255, 0.04);
      --glass-subtle: rgba(255, 255, 255, 0.02);
      --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
      --radius-md: 12px;
      --radius-lg: 16px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* ===== App Layout ===== */
    .app-layout {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 260px;
      background: radial-gradient(circle at top, #111827, #020617);
      border-right: 1px solid var(--border-subtle);
      padding: 24px 20px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.2rem;
      color: #020617;
    }

    .user-info {
      display: flex;
      flex-direction: column;
    }

    .user-info-name {
      font-weight: 600;
    }

    .user-info-email {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .nav-section-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .sidebar-nav {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-item {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid transparent;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.92rem;
      color: var(--text-secondary);
      cursor: pointer;
      background: transparent;
      transition: all 0.15s ease;
    }

    .nav-item span.icon {
      font-size: 1.1rem;
    }

    .nav-item:hover {
      background: var(--glass-subtle);
      border-color: var(--border-subtle);
      color: var(--text-primary);
      transform: translateX(2px);
    }

    .nav-item.active {
      background: linear-gradient(135deg, var(--accent-secondary), #a855f7);
      border-color: transparent;
      color: white;
      box-shadow: 0 0 0 1px rgba(148, 163, 255, 0.5);
    }

    .sidebar-footer {
      margin-top: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .logout-btn {
      margin-top: 4px;
      padding: 8px 12px;
      border-radius: 999px;
      border: none;
      font-size: 0.85rem;
      cursor: pointer;
      background: var(--glass-light);
      color: var(--text-primary);
      align-self: flex-start;
      transition: all 0.15s ease;
    }

    .logout-btn:hover {
      background: var(--glass-subtle);
      transform: translateY(-1px);
    }

    /* ===== Main Content ===== */
    .main-content {
      flex: 1;
      padding: 24px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      animation: fadeIn 0.5s ease;
    }

    header {
      padding: 24px;
      margin-bottom: 24px;
      background: linear-gradient(135deg, var(--glass-light), var(--glass-subtle));
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow-md);
      animation: slideDown 0.5s ease;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    header h1 {
      font-size: 2.4rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    header p {
      color: var(--text-secondary);
      font-size: 0.98rem;
    }

    .header-sub {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* ===== Existing recorder/results styling ===== */
    .recorder {
      background: linear-gradient(180deg, var(--bg-card), var(--bg-secondary));
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-lg);
      animation: slideUp 0.5s ease 0.1s backwards;
    }

    button {
      padding: 10px 20px;
      font-size: 0.95rem;
      font-weight: 600;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.25s ease;
      font-family: inherit;
      margin-right: 12px;
      margin-bottom: 12px;
    }

    #startBtn {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: #0a0e1a;
      box-shadow: 0 4px 12px rgba(110, 231, 183, 0.3);
    }

    #startBtn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(110, 231, 183, 0.4);
    }

    #stopBtn {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    #stopBtn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
    }

    #sendBtn {
      background: linear-gradient(135deg, var(--accent-secondary), #a78bfa);
      color: white;
      box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
    }

    #sendBtn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(96, 165, 250, 0.4);
    }

    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    #status {
      display: inline-block;
      padding: 8px 16px;
      background: var(--glass-light);
      border: 1px solid var(--border-muted);
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 0.8rem;
      font-weight: 500;
      margin: 8px 0 16px;
    }

    #transcript {
      width: 100%;
      min-height: 120px;
      padding: 14px;
      background: var(--glass-subtle);
      border: 2px dashed var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 0.95rem;
      font-family: 'Monaco', 'Courier New', monospace;
      resize: vertical;
      transition: all 0.25s ease;
      margin: 12px 0;
    }

    #transcript:focus {
      outline: none;
      border-color: var(--accent-secondary);
      background: var(--glass-light);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
    }

    #transcript::placeholder {
      color: var(--text-muted);
    }

    .controls {
      display: flex;
      gap: 10px;
      align-items: stretch;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    #participants,
    #emails {
      flex: 1;
      min-width: 220px;
      padding: 12px 14px;
      background: var(--glass-subtle);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 0.95rem;
      font-family: inherit;
      transition: all 0.25s ease;
    }

    #participants:focus,
    #emails:focus {
      outline: none;
      border-color: var(--accent-secondary);
      background: var(--glass-light);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
    }

    #participants::placeholder,
    #emails::placeholder {
      color: var(--text-muted);
    }

    .results-card {
      background: linear-gradient(180deg, var(--bg-card), var(--bg-secondary));
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-lg);
      animation: slideUp 0.5s ease 0.2s backwards;
      min-height: 160px;
    }

    .results-card h2 {
      font-size: 1.4rem;
      margin-bottom: 16px;
      color: var(--text-primary);
    }

    .results-card h3 {
      font-size: 1.1rem;
      margin-top: 20px;
      margin-bottom: 10px;
      color: var(--accent-primary);
      padding-bottom: 6px;
      border-bottom: 1px solid var(--border-subtle);
    }

    #resultsArea {
      color: var(--text-secondary);
      line-height: 1.8;
      font-size: 0.95rem;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 12px 0;
    }

    ul li {
      padding: 12px 14px;
      margin-bottom: 10px;
      background: var(--glass-subtle);
      border: 1px solid var(--border-muted);
      border-radius: var(--radius-md);
      transition: all 0.15s ease;
      line-height: 1.6;
    }

    ul li:hover {
      background: var(--glass-light);
      border-color: var(--border-subtle);
      transform: translateX(4px);
    }

    ul li strong {
      color: var(--accent-primary);
      font-weight: 600;
    }

    ul li em {
      color: var(--accent-secondary);
      font-style: normal;
      font-weight: 700;
      font-size: 1.05em;
    }

    /* ===== Views (Dashboard / History / Profile / Security) ===== */

    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    /* History cards */
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 12px;
    }

    .history-item {
      padding: 14px 16px;
      border-radius: var(--radius-md);
      background: var(--glass-subtle);
      border: 1px solid var(--border-muted);
      font-size: 0.9rem;
    }

    .history-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .history-item-title {
      font-weight: 600;
      color: var(--accent-secondary);
    }

    .history-item-time {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .history-item-body {
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.72rem;
      background: var(--glass-light);
      border: 1px solid var(--border-subtle);
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* Profile view */
    .profile-grid {
      display: grid;
      grid-template-columns: 2fr 1.5fr;
      gap: 20px;
      margin-top: 12px;
    }

    .card {
      background: linear-gradient(180deg, var(--bg-card), var(--bg-secondary));
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      padding: 18px;
      box-shadow: var(--shadow-md);
      font-size: 0.9rem;
    }

    .card h3 {
      font-size: 1rem;
      margin-bottom: 8px;
      color: var(--accent-primary);
    }

    .muted {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    /* Change password form */
    .form-group {
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .form-group label {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .form-group input {
      padding: 10px 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      background: var(--glass-subtle);
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--accent-secondary);
      background: var(--glass-light);
    }

    .small-btn {
      padding: 8px 16px;
      font-size: 0.85rem;
      border-radius: 999px;
      margin-right: 0;
    }

    .status-msg {
      margin-top: 8px;
      font-size: 0.8rem;
    }

    .status-ok {
      color: #4ade80;
    }

    .status-err {
      color: #fca5a5;
    }

    /* Animations + responsive */

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-16px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(16px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 900px) {
      .app-layout {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        flex-direction: row;
        align-items: center;
        gap: 16px;
        overflow-x: auto;
      }
      .sidebar-header {
        flex: 0 0 auto;
      }
      .sidebar-nav {
        flex-direction: row;
        flex-wrap: wrap;
      }
      .sidebar-footer {
        display: none;
      }
      .main-content {
        padding: 16px;
      }
      header {
        padding: 18px;
      }
      .profile-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="app-layout">
    <!-- ============ SIDEBAR ============ -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="avatar" id="avatarInitials">TS</div>
        <div class="user-info">
          <div class="user-info-name" id="sidebarUsername">Loading...</div>
          <div class="user-info-email">TalknSplit user</div>
        </div>
      </div>

      <div>
        <div class="nav-section-title">Main</div>
        <nav class="sidebar-nav">
          <button class="nav-item active" data-view="view-dashboard">
            <span class="icon">üéôÔ∏è</span>
            <span>Record & Split</span>
          </button>
          <button class="nav-item" data-view="view-history">
            <span class="icon">üìú</span>
            <span>History</span>
          </button>
        </nav>
      </div>

      <div>
        <div class="nav-section-title">Account</div>
        <nav class="sidebar-nav">
          <button class="nav-item" data-view="view-profile">
            <span class="icon">üë§</span>
            <span>Profile</span>
          </button>
          <button class="nav-item" data-view="view-security">
            <span class="icon">üîê</span>
            <span>Change Password</span>
          </button>
        </nav>
      </div>

      <div class="sidebar-footer">
        <div>Signed in to TalknSplit</div>
        <button class="logout-btn" onclick="location.href='/logout'">Logout</button>
      </div>
    </aside>

    <!-- ============ MAIN CONTENT ============ -->
    <main class="main-content">
      <div class="container">
        <header>
          <h1>TalknSplit</h1>
          <p>Speak or type your expense (e.g. ‚ÄúI paid 120 for dinner with Alice and Bob‚Äù) and let TalknSplit do the maths.</p>
          <div class="header-sub" id="headerSub"></div>
        </header>

        <!-- DASHBOARD VIEW -->
        <section id="view-dashboard" class="view active">
          <section class="recorder">
            <button id="startBtn">Start Recording</button>
            <button id="stopBtn" disabled>Stop</button>
            <div id="status">Status: idle</div>
            <textarea id="transcript" placeholder="Transcript will appear here..."></textarea>

            <div class="controls">
              <input id="participants" placeholder="Participants (comma-separated) e.g. Alice,Bob,Me" />
              <input id="emails" placeholder="Emails (comma-separated) e.g. a@gmail.com,b@gmail.com" />
              <button id="sendBtn">Send to server</button>
            </div>
          </section>

          <section class="results-card">
            <h2>Splits</h2>
            <div id="resultsArea">No results yet.</div>
          </section>
        </section>

        <!-- HISTORY VIEW -->
        <section id="view-history" class="view">
          <div class="results-card">
            <h2>History</h2>
           
            <div id="historyArea" class="history-list">
              <div class="muted" id="historyEmpty">No history yet. Run a split from the dashboard.</div>
            </div>
          </div>
        </section>

        <!-- PROFILE VIEW -->
        <section id="view-profile" class="view">
          <div class="profile-grid">
            <div class="card">
              <h3>Your profile</h3>
              <p><strong>Username:</strong> <span id="profileUsername">-</span></p>
              <p><strong>Display name:</strong> <span id="profileDisplayName">-</span></p>
              <p class="muted" style="margin-top:8px;">
                These details are based on your login. In a full production version, you could store additional fields
                like phone, photo, college, etc.
              </p>
            </div>
            <div class="card">
              <h3>Project info</h3>
              <p class="muted">
                This dashboard demonstrates:
                <br>- Login & sessions<br>- Voice input (Web Speech API)<br>- Expense parsing & splitting<br>- Email integration<br>- Simple local history & profile views
              </p>
            </div>
          </div>
        </section>

        <!-- SECURITY / CHANGE PASSWORD VIEW -->
        <section id="view-security" class="view">
          <div class="card">
            <h3>Change password</h3>
            <p class="muted">Update your password for this TalknSplit account.</p>

            <form id="changePasswordForm" style="margin-top:12px;">
              <div class="form-group">
                <label for="currentPassword">Current password</label>
                <input type="password" id="currentPassword" required />
              </div>
              <div class="form-group">
                <label for="newPassword">New password</label>
                <input type="password" id="newPassword" required />
              </div>
              <div class="form-group">
                <label for="confirmPassword">Confirm new password</label>
                <input type="password" id="confirmPassword" required />
              </div>
              <button type="submit" class="small-btn" id="changePassBtn">Update password</button>
              <div class="status-msg" id="changePassStatus"></div>
            </form>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    // ===== Element references =====
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusEl = document.getElementById('status');
    const transcriptEl = document.getElementById('transcript');
    const sendBtn = document.getElementById('sendBtn');
    const participantsEl = document.getElementById('participants');
    const emailsEl = document.getElementById('emails');
    const resultsArea = document.getElementById('resultsArea');

    const sidebarUsernameEl = document.getElementById('sidebarUsername');
    const avatarInitialsEl = document.getElementById('avatarInitials');
    const headerSubEl = document.getElementById('headerSub');
    const profileUsernameEl = document.getElementById('profileUsername');
    const profileDisplayNameEl = document.getElementById('profileDisplayName');

    const historyArea = document.getElementById('historyArea');
    const historyEmpty = document.getElementById('historyEmpty');

    const changePasswordForm = document.getElementById('changePasswordForm');
    const changePassStatus = document.getElementById('changePassStatus');
    const changePassBtn = document.getElementById('changePassBtn');

    let recognition;
    let currentUsername = null;

    // ===== View switching (Sidebar) =====
    const navItems = document.querySelectorAll('.nav-item');
    const views = document.querySelectorAll('.view');

    navItems.forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.getAttribute('data-view');
        // active nav
        navItems.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        // active view
        views.forEach(v => {
          if (v.id === target) v.classList.add('active');
          else v.classList.remove('active');
        });
        // if history view selected, refresh history rendering
        if (target === 'view-history') {
          renderHistory();
        }
      });
    });

    // ===== Fetch current user (for profile / sidebar / history key) =====
    async function loadCurrentUser() {
      try {
        const res = await fetch('/api/me', { method: 'GET' });
        if (!res.ok) throw new Error('Failed to load user');
        const data = await res.json();
        currentUsername = data.username || 'User';

        sidebarUsernameEl.textContent = currentUsername;
        profileUsernameEl.textContent = currentUsername;
        profileDisplayNameEl.textContent = currentUsername;

        const initials = currentUsername.trim().charAt(0).toUpperCase() || 'T';
        avatarInitialsEl.textContent = initials;

        headerSubEl.textContent = `Logged in as ${currentUsername}`;
      } catch (err) {
        console.error('Error loading current user:', err);
        sidebarUsernameEl.textContent = 'TalknSplit user';
      }
    }

    loadCurrentUser();

    // ===== Speech Recognition =====
    if (window.SpeechRecognition || window.webkitSpeechRecognition) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.addEventListener('start', () => {
        statusEl.textContent = 'Status: listening...';
      });
      recognition.addEventListener('end', () => {
        statusEl.textContent = 'Status: idle';
        stopBtn.disabled = true;
        startBtn.disabled = false;
      });
      recognition.addEventListener('result', (e) => {
        const text = Array.from(e.results).map(r => r[0].transcript).join(' ');
        transcriptEl.value = (transcriptEl.value ? transcriptEl.value + ' ' : '') + text;
      });
    } else {
      statusEl.textContent = 'Status: SpeechRecognition not supported ‚Äî please type manually.';
      startBtn.disabled = true;
      stopBtn.disabled = true;
    }

    startBtn.onclick = () => {
      if (!recognition) return;
      recognition.start();
      startBtn.disabled = true;
      stopBtn.disabled = false;
    };
    stopBtn.onclick = () => recognition && recognition.stop();

    // ===== Local history helpers (stored per user in localStorage) =====
    function getHistoryKey() {
      return currentUsername ? `talknsplit_history_${currentUsername}` : 'talknsplit_history';
    }

    function saveToHistory(entry) {
      try {
        const key = getHistoryKey();
        const existing = JSON.parse(localStorage.getItem(key) || '[]');
        existing.unshift(entry); // latest first
        if (existing.length > 20) existing.length = 20; // keep last 20
        localStorage.setItem(key, JSON.stringify(existing));
      } catch (e) {
        console.warn('Unable to save history:', e);
      }
    }

    function renderHistory() {
      const key = getHistoryKey();
      let items = [];
      try {
        items = JSON.parse(localStorage.getItem(key) || '[]');
      } catch {
        items = [];
      }

      historyArea.innerHTML = '';
      if (!items.length) {
        historyArea.appendChild(historyEmpty);
        historyEmpty.style.display = 'block';
        return;
      } else {
        historyEmpty.style.display = 'none';
      }

      items.forEach(entry => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `
          <div class="history-item-header">
            <div class="history-item-title">${escapeHtml(entry.title || 'Expense')}</div>
            <div class="history-item-time">${escapeHtml(entry.time || '')}</div>
          </div>
          <div class="history-item-body">
            <div><strong>Transcript:</strong> ${escapeHtml(entry.transcript || '')}</div>
            <div><strong>Participants:</strong> ${escapeHtml(entry.participants || '')}</div>
            <div><strong>Total expenses:</strong> ${entry.totalAmount != null ? Number(entry.totalAmount).toFixed(2) : '-'}</div>
          </div>
          
        `;
        historyArea.appendChild(div);
      });
    }

    // ===== Send transcript to server =====
    sendBtn.onclick = async () => {
      const transcript = transcriptEl.value.trim();
      const participants = participantsEl.value
        .split(',')
        .map(s => s.trim())
        .filter(Boolean);

      const emails = emailsEl.value
        .split(',')
        .map(s => s.trim())
        .filter(Boolean);

      if (!transcript) return alert('Please provide a transcript (voice or typed).');
      resultsArea.textContent = 'Processing...';

      try {
        const res = await fetch('/api/process-transcript', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include', // ensure session cookie is sent
          body: JSON.stringify({ transcript, participants, emails })
        });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        renderResults(data);

        // Save to local history
        const total = Array.isArray(data.expenses)
          ? data.expenses.reduce((sum, e) => sum + (Number(e.amount) || 0), 0)
          : 0;
        const now = new Date();
        saveToHistory({
          time: now.toLocaleString(),
          transcript,
          participants: participants.join(', '),
          totalAmount: total,
          title: data.expenses && data.expenses.length
            ? `${data.expenses.length} expense(s)`
            : 'No expenses parsed'
        });

      } catch (err) {
        console.error(err);
        resultsArea.textContent = 'Error: ' + err.message;
      }
    };

    function renderResults(data) {
      if (!data) { resultsArea.textContent = 'No data'; return; }
      const { expenses = [], balances = {}, settleUp = [] } = data;
      const html = [];
      html.push('<h3>Parsed expenses</h3>');
      html.push('<ul>');
      for (const e of expenses) {
        html.push(
          `<li><strong>${escapeHtml(e.payer)}</strong> paid <em>${e.amount}</em> for ${escapeHtml(e.description || 'expense')} ‚Äî split among: ${
            Array.isArray(e.split_with) ? e.split_with.join(', ') : ''
          }</li>`
        );
      }
      html.push('</ul>');

      html.push('<h3>Balances</h3>');
      html.push('<ul>');
      for (const [name, bal] of Object.entries(balances)) {
        html.push(`<li>${escapeHtml(name)}: ${Number(bal).toFixed(2)}</li>`);
      }
      html.push('</ul>');

      html.push('<h3>Suggested Settlements</h3>');
      if (settleUp && settleUp.length) {
        html.push('<ul>');
        for (const s of settleUp) {
          html.push(`<li>${escapeHtml(s.from)} ‚Üí ${escapeHtml(s.to)} : ${Number(s.amount).toFixed(2)}</li>`);
        }
        html.push('</ul>');
      } else {
        html.push('<p>Already balanced.</p>');
      }

      resultsArea.innerHTML = html.join('');
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, function (s) {
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[s];
      });
    }

    // ===== Change password =====
    changePasswordForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      changePassStatus.textContent = '';
      changePassStatus.className = 'status-msg';

      const current = document.getElementById('currentPassword').value;
      const next = document.getElementById('newPassword').value;
      const confirm = document.getElementById('confirmPassword').value;

      if (!current || !next || !confirm) {
        changePassStatus.textContent = 'Please fill all fields.';
        changePassStatus.classList.add('status-err');
        return;
      }
      if (next !== confirm) {
        changePassStatus.textContent = 'New password and confirm password do not match.';
        changePassStatus.classList.add('status-err');
        return;
      }

      changePassBtn.disabled = true;
      changePassBtn.textContent = 'Updating...';

      try {
        const res = await fetch('/api/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ currentPassword: current, newPassword: next })
        });
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch { data = { error: text }; }

        if (!res.ok || data.error) {
          throw new Error(data.error || 'Failed to update password');
        }
        changePassStatus.textContent = 'Password updated successfully.';
        changePassStatus.classList.add('status-ok');
        changePasswordForm.reset();
      } catch (err) {
        console.error(err);
        changePassStatus.textContent = err.message;
        changePassStatus.classList.add('status-err');
      } finally {
        changePassBtn.disabled = false;
        changePassBtn.textContent = 'Update password';
      }
    });
  </script>
</body>
</html>
